
---
title:           Lockdown Greenspace Access
author:          Dr Ali Lakhani, Dr Dennis Wollersheim, Mr Prosper Korah, Professor Elizabeth Kendall
date:            25.07.2020
linkcolor:       cyan
citecolor:       grey
output:
workflowr::wflow_html:
code_folding: hide
---

\tableofcontents


```{r init, include=F}

source('_drake.R')

loadd(df_mesh_lockdown_summary)
loadd(map_mesh)
loadd(df_mesh_lockdown)
loadd(df_mesh_detail)
```

# No Parkland Meshblock Summary


```{r}

  df_mesh_lockdown_summary %>%
    filter(as.numeric(area)==0) %>%
  { . } -> df_none

df_none %>%
  count( MB_CATEGORY_NAME_2016, sort=TRUE) %>%
  gt::gt() %>%
  gt::tab_header(
           title = "Meshblocks with no parks within 5km",
           subtitle = "Number by category"
)

df_none %>%
  select(-starts_with('mc'), -State) %>%
  summarise( across( where(is.numeric),
                    .fns=list(mean=mean, max=max, min=min, sd=sd, total = sum))) %>%
  gt::gt() %>%
gt::tab_header(
               title = "Meshblocks with no parks within 5km",
               subtitle = "Summary statistics"
)

# LGA level summary

```{r}

df_mesh_lockdown_summary  %>%
  group_by(lga_name) %>%
  select(-starts_with('mc'), -State) %>%
  mutate( area = units::set_units( area, 'km^2') ) %>%
  summarise(across(.cols=where(is_numeric),
                   .fns=list(mean=mean, max=max, min=min, sd=sd, total = sum),
                   .names = "{col}.{fn}"), number_mesh_blocks = n(),
            .groups='drop') %>%
  { . } -> df_lga_summary

df_lga_summary %>%
  gt::gt() %>%
gt::tab_header(
               title = "Lga Summary"
)

df_mesh_lockdown_summary  %>%
  write_csv('output/lockdown_greenspace_mesh_detail.csv')

df_lga_summary %>%
  write_csv('output/lockdown_greenspace_lga_summary.csv')

```

# SA2 level summary

```{r SA2}

df_mesh_lockdown_summary  %>%
  group_by(SA2_MAIN16) %>%
  select(-starts_with('mc'), -State) %>%
  mutate( area = units::set_units( area, 'km^2') ) %>%
  summarise(across(.cols=where(is_numeric),
                   .fns=list(mean=mean, max=max, min=min, sd=sd, total = sum),
                   .names = "{col}.{fn}"), number_mesh_blocks = n(),
            .groups='drop') %>%
  { . } -> df_sa2_summary

df_sa2_summary %>%
  head(10) %>%
  gt::gt() %>%
gt::tab_header(
               title = "SA2 Summary",
               subtitle = "First 10 rows"
)

df_sa2_summary %>%
  write_csv('output/lockdown_greenspace_sa2_summary.csv')

```

# SA1 level summary

```{r SA1}

df_mesh_lockdown_summary  %>%
  group_by(SA1_MAIN16) %>%
  select(-starts_with('mc'), -State) %>%
  mutate( area = units::set_units( area, 'km^2') ) %>%
  summarise(across(.cols=where(is_numeric),
                   .fns=list(mean=mean, max=max, min=min, sd=sd, total = sum),
                   .names = "{col}.{fn}"), number_mesh_blocks = n(),
            .groups='drop') %>%
  { . } -> df_sa1_summary

df_sa1_summary %>%
  head(10) %>%
  gt::gt() %>%
  gt::tab_header(
                 title = "SA1 Summary",
                 subtitle = "First 10 rows"
  )


df_sa1_summary %>%
  write_csv('output/lockdown_greenspace_sa1_summary.csv')

```

# Map
```{r map1}

map_mesh %>%
  inner_join(df_mesh_lockdown_summary, by = "MB_CODE16" ) %>%
  mutate( area = units::set_units( area, 'km^2') %>% as.numeric() ) %>%
  ggplot() +
  geom_sf( aes( fill = area ),lwd=0 ) +
  scale_fill_viridis_c(option = "plasma") +
  ggtitle('Km^2 greenspace access within 5km of meshblock')

```

# Green Map
```{r map2}

map_mesh %>%
  inner_join(df_mesh_lockdown_summary, by = "MB_CODE16" ) %>%
  filter( MB_CATEGORY_NAME_2016 == 'Parkland') %>%
  { . } -> df_parks

map_mesh %>%
  inner_join(df_mesh_lockdown_summary, by = "MB_CODE16" ) %>%
  filter( MB_CATEGORY_NAME_2016 != 'Parkland') %>%
  mutate( area = units::set_units( area, 'km^2') %>% as.numeric() ) %>%
  ggplot() +
  geom_sf( aes( fill = area ),lwd=0 ) +
  geom_sf(data=df_parks, fill="green") +
  scale_fill_viridis_c(option = "plasma") +
  ggtitle('Km^2 greenspace access within 5km of meshblock. Green is parks')

```


# Interactive Map
```{r interactive_map2}
map_levels = c('Park','0-5', '5-10', '10-15','15-20','>20')

map_colors = c(
               RColorBrewer::brewer.pal(3,'Greens')[1],
               RColorBrewer::brewer.pal(5,'Blues'))

map_palette = colorFactor(map_colors, levels=map_levels)

map_mesh %>%
  inner_join(df_mesh_lockdown_summary, by = "MB_CODE16" ) %>%
  mutate( area = units::set_units( area, 'km^2') %>% as.numeric() ) %>%
  mutate( area=ifelse( MB_CATEGORY_NAME_2016 == 'Parkland', -1, area )) %>%
  mutate( area_factor = cut( area, breaks= c(-2,0, 5,10,15,20,99),
                            labels= map_levels )) %>%
  { . } -> df_leaflet


df_leaflet %>%
  leaflet() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1,
              color = ~map_palette(area_factor)) %>%
  addLegend("bottomright", pal = map_palette, values = ~area_factor,
            title = "Total parks within 5km circle",
            opacity = 1
  )



```
